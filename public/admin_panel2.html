<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Super Admin Panel 2 - LabLinX DLSU-D</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 1. Global Styles & Variables (DLSU Theme) --- */
        :root {
            --primary-dark: #00503B; /* DLSU Deep Green */
            --primary-light: #007A5A; /* DLSU Lighter Green */
            --accent-gold: #FFCD00; /* DLSU Gold */
            --text-light: #f8f9fa;
            --text-dark: #343a40;
            --background-light: #f4f6f9;
            --background-dark: #181a1f;
            --card-bg-light: #ffffff;
            --card-bg-dark: #212529;
            --border-light: #dee2e6;
            --border-dark: #495057;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #f0ad4e;
            --info: #17a2b8;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --font-family: "Avenir", "Helvetica Neue", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        /* Chart Container styles */
        .chart-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        .chart-card {
            background-color: var(--card-bg-light);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-light);
        }
        body.dark .chart-card {
            background-color: var(--card-bg-dark);
            border-color: var(--border-dark);
        }
        /* Reset & Base */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { font-family: var(--font-family); background-color: var(--background-light); color: var(--text-dark); min-height: 100vh; overflow-x: hidden; transition: background-color 0.3s ease, color 0.3s ease; }
        body.dark { background-color: var(--background-dark); color: var(--text-light); }
        a { text-decoration: none; color: inherit; }

        /* --- 2. Sidebar --- */
        #sidebar { width: 250px; background-color: var(--primary-dark); height: 100vh; color: var(--text-light); position: fixed; top: 0; left: 0; display: flex; flex-direction: column; padding: 1.5rem 0; z-index: 200; transition: width 0.3s ease; border-right: 1px solid var(--primary-light); }
        #sidebar .logo { display: flex; flex-direction: column; align-items: center; margin-bottom: 2rem; padding: 0 1rem; }
        #sidebar .logo img { width: 70px; height: 70px; margin-bottom: 0.5rem; border-radius: 50%; cursor: pointer; }
        #sidebar .logo-title { color: var(--accent-gold); font-weight: 700; font-size: 1rem; opacity: 1; transition: opacity 0.2s ease; }
        #sidebar nav { display: flex; flex-direction: column; width: 100%; margin-top: 1rem; flex-grow: 1; overflow-y: auto; }
        #sidebar nav a { color: #e0e0e0; padding: 14px 25px; font-weight: 500; display: flex; align-items: center; justify-content: space-between; gap: 15px; transition: background-color 0.2s, color 0.2s, border-left-color 0.2s; border-left: 4px solid transparent; cursor: pointer; }
        #sidebar nav a .link-content { display: flex; align-items: center; gap: 15px; }
        #sidebar nav a svg { width: 20px; height: 20px; flex-shrink: 0; }
        #sidebar nav a:hover { background-color: var(--primary-light); color: var(--accent-gold); }
        #sidebar nav a.active { background-color: var(--accent-gold); color: var(--primary-dark); font-weight: 600; border-left-color: #fff; }
        .logout-link { margin-top: auto; }
        .notification-badge { background-color: var(--danger); color: white; font-size: 0.75rem; font-weight: bold; padding: 2px 7px; border-radius: 50%; display: none; }
        body.sidebar-collapsed #sidebar { width: 80px; }
        body.sidebar-collapsed .logo-title, body.sidebar-collapsed nav a span, body.sidebar-collapsed .notification-badge { display: none; }
        body.sidebar-collapsed nav a { justify-content: center; }

        /* --- 3. Header / Topbar --- */
        header { margin-left: 250px; height: 65px; background-color: var(--card-bg-light); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 150; transition: margin-left 0.3s ease, background-color 0.3s ease; border-bottom: 1px solid var(--border-light); }
        body.dark header { background-color: var(--card-bg-dark); border-bottom-color: var(--border-dark); }
        body.sidebar-collapsed header { margin-left: 80px; }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .toggle-btn { background: none; border: none; cursor: pointer; color: var(--text-dark); }
        body.dark .toggle-btn { color: var(--text-light); }
        .toggle-btn svg { width: 24px; height: 24px; }
        .top-actions { display: flex; align-items: center; gap: 1.5rem; }
        .dark-toggle { background: none; border: none; cursor: pointer; color: var(--text-dark); }
        body.dark .dark-toggle { color: var(--text-light); }
        .dark-toggle svg { width: 22px; height: 22px; }
        .profile img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary-dark); }

        /* --- 4. Main Content --- */
        main { margin-left: 250px; padding: 2.5rem; transition: margin-left 0.3s ease; }
        body.sidebar-collapsed main { margin-left: 80px; }
        main h1 { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--primary-dark); }
        body.dark main h1 { color: var(--accent-gold); }
        .page-subtitle { margin-top: 0; margin-bottom: 2.5rem; font-size: 1.1rem; color: #6c757d; font-weight: 500; }
        body.dark .page-subtitle { color: #adb5bd; }
        .page-content { display: none; }
        .page-content.active { display: block; }

        /* --- 5. Dashboard Specific Styles --- */
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; }
        .card { background-color: var(--card-bg-light); border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow); transition: transform 0.25s ease, box-shadow 0.25s ease; border: 1px solid var(--border-light); display: flex; flex-direction: column; justify-content: space-between; min-height: 180px; }
        body.dark .card { background-color: var(--card-bg-dark); border-color: var(--border-dark); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .card-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .card-icon { width: 48px; height: 48px; border-radius: 8px; display: grid; place-items: center; }
        .card-icon svg { width: 28px; height: 28px; color: #fff; }
        .icon-aqua { background-color: #1abc9c; } .icon-red { background-color: #e74c3c; } .icon-green { background-color: #2ecc71; }
        .card-header-text .title { font-weight: 600; font-size: 1rem; }
        .card-header-text .subtitle { font-size: 0.85rem; color: #6c757d; }
        body.dark .card-header-text .subtitle { color: #adb5bd; }
        .card-body .counter { font-size: 2.8rem; font-weight: 700; line-height: 1; color: var(--primary-dark); }
        body.dark .card-body .counter { color: var(--text-light); }
        .card-body .items { font-size: 0.9rem; margin-top: 4px; color: #6c757d; }
        body.dark .card-body .items { color: #adb5bd; }
        .card-footer { margin-top: 1.5rem; font-size: 0.9rem; font-weight: 500; color: var(--primary-light); display: flex; align-items: center; gap: 5px; }
        body.dark .card-footer { color: var(--accent-gold); }

        /* --- 6. Inventory, Requests & Notifications Styles --- */
        .inventory-card { background-color: var(--card-bg-light); border-radius: 8px; width: 100%; padding: 1.5rem 2rem; margin-bottom: 2rem; box-shadow: var(--shadow); border: 1px solid var(--border-light); }
        body.dark .inventory-card { background-color: var(--card-bg-dark); border-color: var(--border-dark); }
        .inventory-card h2 { margin-top: 0; margin-bottom: 1.5rem; font-size: 1.5rem; color: var(--primary-dark); border-bottom: 1px solid var(--border-light); padding-bottom: 0.75rem; }
        body.dark .inventory-card h2 { color: var(--accent-gold); border-bottom-color: var(--border-dark); }
        .filter-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
        .search-bar { flex-grow: 1; min-width: 250px; }
        .search-bar input, .filter-select select, .filter-row button {
            width: 100%; padding: 10px 15px;
            border-radius: 6px; border: 1px solid var(--border-light);
            font-size: 1rem; background-color: var(--card-bg-light);
            color: var(--text-dark); transition: all 0.3s ease;
        }
        .filter-row button { 
            width: auto; cursor: pointer; font-weight: 600;
            background-color: #e9ecef; border-color: #ced4da;
        }
        .filter-row button:hover { background-color: #dde1e5; }
        body.dark .search-bar input, body.dark .filter-select select, body.dark .filter-row button {
            background-color: #2a2a2e; border-color: var(--border-dark); color: var(--text-light);
        }
        body.dark .filter-row button { background-color: #343a40; border-color: #495057; }
        body.dark .filter-row button:hover { background-color: #495057; }
        .search-bar input:focus, .filter-select select:focus {
            outline: none; box-shadow: 0 0 0 3px rgba(0, 80, 59, 0.25);
        }
        .filter-select { display: flex; flex-direction: column; gap: 0.25rem; }
        .filter-select label { font-size: 0.85rem; font-weight: 500; color: var(--text-subtle); }
        body.dark .filter-select label { color: var(--text-subtle-dark-mode); }

        .add-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; align-items: flex-end; }
        .add-form input, .add-form select { padding: 8px 12px; border-radius: 5px; border: 1px solid var(--border-light); font-size: 0.95rem; width: 100%; background-color: var(--card-bg-light); color: var(--text-dark); }
        body.dark .add-form input, body.dark .add-form select { background-color: var(--card-bg-dark); border-color: var(--border-dark); color: var(--text-light); }
        .add-form button { background-color: var(--primary-dark); color: var(--accent-gold); padding: 9px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: 600; transition: background-color 0.2s; white-space: nowrap; }
        .add-form button:hover { background-color: var(--primary-light); }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; table-layout: fixed; }
        table th, table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-light); word-wrap: break-word; }
        body.dark table th, body.dark table td { border-bottom-color: var(--border-dark); }
        table th { background-color: var(--background-light); color: var(--primary-dark); font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        body.dark table th { background-color: var(--background-dark); color: var(--text-light); }
        table tr:last-child td { border-bottom: none; }
        table tbody tr:hover { background-color: #fcf8e3; }
        body.dark table tbody tr:hover { background-color: #2c2f33; }
        table td .status-select { padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-light); font-weight: 500; background: transparent; color: var(--text-dark); }
        body.dark table td .status-select { border-color: var(--border-dark); color: var(--text-light); }
        body.dark table td .status-select option { background-color: var(--card-bg-dark); }
        .status-Available { color: var(--success); } .status-In-Use { color: var(--warning); } .status-Maintenance { color: var(--danger); }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; color: white; text-align: center; }
        .status-Pending { background-color: var(--warning); }
        .status-Approved { background-color: var(--success); }
        .status-Rejected { background-color: var(--danger); }
        .status-Returned { background-color: #6c757d; }
        .actions-cell { display: flex; gap: 10px; padding: 15px; width: auto; }
        .btn { padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85rem; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; transition: opacity 0.2s; white-space: nowrap; }
        .btn:hover { opacity: 0.85; }
        .btn svg { width: 14px; height: 14px; }
        .btn-edit { background-color: var(--success); color: white; }
        .btn-delete { background-color: var(--danger); color: white; }
        .btn-restore { background-color: var(--info); color: white; }
        #notification-list .notification-item { background-color: var(--card-bg-light); border-left: 5px solid var(--primary-light); margin-bottom: 1rem; padding: 1rem; border-radius: 5px; box-shadow: var(--shadow); }
        body.dark #notification-list .notification-item { background-color: var(--card-bg-dark); border-left-color: var(--accent-gold); }
        #notification-list .notification-title { font-weight: bold; color: var(--primary-dark); margin-bottom: 0.25rem; }
        body.dark #notification-list .notification-title { color: var(--accent-gold); }
        #notification-list .notification-message { color: #6c757d; }
        body.dark #notification-list .notification-message { color: #adb5bd; }
        #notification-list .notification-time { font-size: 0.8rem; color: #6c757d; margin-top: 0.5rem; text-align: right; }
        body.dark #notification-list .notification-time { color: #adb5bd; }
        
        /* --- 7. Modal & Toast Styles --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--card-bg-light); margin: auto; padding: 25px; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        body.dark .modal-content { background-color: var(--card-bg-dark); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { margin: 0; color: var(--primary-dark); }
        body.dark .modal-header h2 { color: var(--text-light); }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: var(--text-dark); }
        body.dark .close-button:hover, body.dark .close-button:focus { color: var(--text-light); }
        .modal-content form { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        .modal-content form label { font-weight: 600; margin-bottom: -10px; }
        .modal-content form input, .modal-content form textarea, .modal-content form select { width: 100%; padding: 10px; border: 1px solid var(--border-light); border-radius: 5px; background-color: var(--card-bg-light); color: var(--text-dark); }
        body.dark .modal-content form input, body.dark .modal-content form textarea, body.dark .modal-content form select { background-color: var(--card-bg-dark); border-color: var(--border-dark); color: var(--text-light); }
        .modal-content form button { background-color: var(--primary-dark); color: white; padding: 12px; border: none; border-radius: 5px; font-weight: 600; cursor: pointer; margin-top: 1rem; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; background-color: var(--primary-dark); color: white; border-radius: 6px; box-shadow: var(--shadow); }

        /* --- 8. Responsive Design --- */
        @media screen and (max-width: 992px) {
            .chart-container { grid-template-columns: 1fr; }
        }
        @media screen and (max-width: 768px) { body:not(.sidebar-collapsed) #sidebar { width: 80px; } body:not(.sidebar-collapsed) .logo-title, body:not(.sidebar-collapsed) nav a span { display: none; } body:not(.sidebar-collapsed) nav a { justify-content: center; } header, main { margin-left: 80px; } main { padding: 1.5rem; } }
        @media screen and (max-width: 600px) { body { padding-bottom: 60px; } #sidebar { bottom: 0; top: auto; width: 100%; height: 60px; flex-direction: row; align-items: center; justify-content: space-around; border-top: 1px solid var(--border-light); padding: 0; } body.dark #sidebar { border-top-color: var(--border-dark); } #sidebar .logo { display: none; } #sidebar nav { margin-top: 0; flex-direction: row; width: 100%; justify-content: space-around; } #sidebar nav a { border-left: none; border-top: 4px solid transparent; } #sidebar nav a.active { border-top-color: #fff; border-left-color: transparent;} .logout-link { display: none; } header, main { margin-left: 0; } }

        /* --- Period Buttons --- */
        .period-btn {
            background-color: #f0f0f0; color: var(--primary-dark); padding: 8px 16px; border-radius: 5px;
            border: 1px solid var(--border-light); cursor: pointer; font-weight: 600;
            margin-right: 10px; transition: background-color 0.2s, color 0.2s;
        }
        .period-btn:hover, .period-btn.active { background-color: var(--accent-gold); color: var(--primary-dark); }
        body.dark .period-btn { background-color: var(--background-dark); border-color: var(--border-dark); color: var(--text-light); }
        body.dark .period-btn:hover, body.dark .period-btn.active { background-color: var(--accent-gold); color: var(--primary-dark); }
        
        /* --- 9. Live Scan Styles --- */
        .live-scan-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .live-scan-container .form-group {
            margin-bottom: 1.5rem;
        }
        .live-scan-container .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .live-scan-container .scan-input {
            font-size: 1.5rem;
            padding: 15px;
            text-align: center;
            border: 2px dashed var(--border-light);
            border-radius: 8px;
            width: 100%;
            background-color: var(--card-bg-light);
            color: var(--text-dark);
        }
        .prefix-input {
            font-size: 1.2rem;
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            width: 100%;
        }
        body.dark .prefix-input {
             background-color: var(--card-bg-dark);
             border-color: var(--border-dark);
             color: var(--text-light);
        }

        body.dark .live-scan-container .scan-input { 
            border-color: var(--border-dark); 
            background-color: var(--card-bg-dark);
            color: var(--text-light);
        }
        .live-scan-container .scan-input:focus { 
            border-style: solid; 
            border-color: var(--primary-light); 
            outline: none;
        }
        .live-scan-container .scan-input:read-only {
            background-color: var(--background-light);
            border-style: solid;
            cursor: not-allowed;
        }
        body.dark .live-scan-container .scan-input:read-only {
             background-color: var(--background-dark);
        }

        .scan-controls { display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem; }
        .scan-controls label { font-weight: 600; }
        .scan-controls select { padding: 8px; border-radius: 5px; border: 1px solid var(--border-light); }
        
        .auto-submit-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: auto; /* Pushes it to the right */
        }
        .auto-submit-toggle label {
            cursor: pointer;
            user-select: none;
        }
        
        .status-box {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 500;
            text-align: center;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--background-light);
            border: 1px solid var(--border-light);
        }
        body.dark .status-box { background-color: var(--background-dark); border-color: var(--border-dark); }
        .status-box.success { border-left: 5px solid var(--success); color: var(--success); }
        .status-box.error { border-left: 5px solid var(--danger); color: var(--danger); }

        #capturedStudentIdDisplay { font-weight: 600; margin-top: 1rem; color: var(--primary-light); }
        body.dark #capturedStudentIdDisplay { color: var(--accent-gold); }

        #trackingDetailsContainer h3 { margin-top: 0; margin-bottom: 0.5rem; font-size: 1.25rem; }
        #trackingDetailsContainer .detail-item { font-weight: 600; }
        #trackingBorrowerInfo {
            background-color: #fff3cd;
            color: #664d03;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            border: 1px solid #ffecb5;
        }
        body.dark #trackingBorrowerInfo {
            background-color: #332701;
            color: #ffc107;
            border-color: #664d03;
        }
        #trackingHistoryLog {
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }
        #trackingHistoryLog div {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-light);
        }
        body.dark #trackingHistoryLog div { border-bottom-color: var(--border-dark); }

    </style>
</head>
<body>
    <aside id="sidebar">
        <div class="logo">
            <img src="logo.png" alt="LabLinX Logo">
            <div class="logo-title">LabLinX DLSU-D</div>
        </div>
        <nav>
            <a data-page="dashboard" class="active">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                    <span>Dashboard</span>
                </div>
            </a>
            <a data-page="live-scan">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0113.5 9.375v-4.5z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5z" /></svg>
                    <span>Live Scan</span>
                </div>
            </a>
            <a data-page="super-admin">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    <span>Super Admin</span>
                </div>
            </a>
            <a data-page="user-management">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.975 5.975 0 0112 13a5.975 5.975 0 013 1.182M15 21a6 6 0 00-9-5.197" /></svg>
                    <span>User Management</span>
                </div>
            </a>
            <a data-page="profile-requests">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                    <span>Profile Requests</span>
                </div>
            </a>
            <a data-page="registration-requests">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z" />
                    </svg>
                    <span>Registration Requests</span>
                </div>
            </a>
            <a data-page="inventory">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                    <span>Inventory</span>
                </div>
            </a>
            <a data-page="requests">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                    <span>Requests</span>
                </div>
            </a>
            <a data-page="notifications">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                    <span>Notifications</span>
                </div>
                <span id="notification-badge" class="notification-badge">0</span>
            </a>
             <a data-page="history">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                    <span>History</span>
                </div>
            </a>
            <a data-page="reports">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-6a2 2 0 012-2h6M9 17H5a2 2 0 01-2-2v-6a2 2 0 012-2h4m6 10v4m0-4h4m-4 0H9" /></svg>
                    <span>Reports</span>
                </div>
            </a>
            <a href="/logout" class="logout-link">
                <div class="link-content">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    <span>Log Out</span>
                </div>
            </a>
        </nav>
    </aside>

    <header>
        <div class="header-left">
            <button class="toggle-btn" title="Toggle Sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
            </button>
        </div>
        <div class="top-actions">
            <button class="dark-toggle" title="Toggle Dark Mode">
                <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <svg class="moon-icon" style="display:none;" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
            <a href="#" class="profile">
                <img src="https://i.pravatar.cc/40" alt="User Profile Picture">
            </a>
        </div>
    </header>

    <main>
        <div id="dashboard-content" class="page-content active">
            <h1>Super Admin Dashboard</h1>
            <p class="page-subtitle">Monitoring overview of all admin panels.</p>
            <section class="dashboard-cards">
                 <article class="card">
                    <div class="card-header"><div class="card-icon" style="background-color: #3498db;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h6.375a.75.75 0 01.75.75v3.375a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75V7.5a.75.75 0 01.75-.75zM9 15h6.375a.75.75 0 01.75.75v3.375a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75V15.75a.75.75 0 01.75-.75z" /></svg></div><div class="card-header-text"><div class="title">Total Facility Items</div><div class="subtitle">Admin Panel 3</div></div></div>
                    <div class="card-body"><h2 class="counter" id="admin3-total-card">0</h2><div class="items">Units</div></div>
                </article>
                 <article class="card">
                    <div class="card-header"><div class="card-icon" style="background-color: #9b59b6;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-15 3.75H3m18 0h-1.5M8.25 21v-1.5M15.75 3v1.5M12 4.5v-1.5m0 18v-1.5M5.636 5.636l1.06-1.06M5.636 18.364l1.06 1.06M18.364 5.636l-1.06-1.06M18.364 18.364l-1.06 1.06M12 12a6 6 0 110-12 6 6 0 010 12z" /></svg></div><div class="card-header-text"><div class="title">Total Robotics Items</div><div class="subtitle">Admin Panel 4</div></div></div>
                    <div class="card-body"><h2 class="counter" id="admin4-total-card">0</h2><div class="items">Units</div></div>
                </article>
                 <article class="card">
                    <div class="card-header"><div class="card-icon icon-aqua"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 6.087c0-.355.186-.676.401-.959.215-.283.49-.522.799-.68a3.743 3.743 0 011.286-.294c.486-.01.97.086 1.424.275.454.19.868.45 1.226.774a3.732 3.732 0 01.96 1.226c.19.454.285.938.275 1.424a3.743 3.743 0 01-.294 1.286c-.158.309-.397.584-.68.799-.283.215-.604.401-.959.401a3.743 3.743 0 01-1.286.294c-.486.01-.97-.086-1.424-.275a3.732 3.732 0 01-1.226-.96c-.283-.454-.486-.97-.486-1.5z M4.5 12a7.5 7.5 0 0015 0h-15z" /></svg></div><div class="card-header-text"><div class="title">Total Science Items</div><div class="subtitle">Admin Panel 2</div></div></div>
                    <div class="card-body"><h2 class="counter" id="admin2-science-card">0</h2><div class="items">Units</div></div>
                </article>
                <article class="card">
                    <div class="card-header"><div class="card-icon" style="background-color: #e67e22;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 4.5l7.5 7.5-7.5 7.5" /></svg></div><div class="card-header-text"><div class="title">Total Sports Items</div><div class="subtitle">Admin Panel 2</div></div></div>
                    <div class="card-body"><h2 class="counter" id="admin2-sports-card">0</h2><div class="items">Units</div></div>
                </article>

            </section>
            <div class="chart-container">
                <div class="chart-card">
                    <h2>Inventory Overview</h2>
                    <canvas id="inventoryPieChart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Request Status Overview</h2>
                    <canvas id="requestStatusBarChart"></canvas>
                </div>
            </div>
        </div>

        <div id="live-scan-content" class="page-content">
            <h1>Live Scan Transaction</h1>
            <p class="page-subtitle">Process transactions and view real-time item status and history.</p>
            <div class="live-scan-container">
                <section class="inventory-card">
                    <h2>Transaction Processor</h2>
                    <div class="scan-controls">
                        <label for="scanMode">Mode:</label>
                        <select id="scanMode">
                            <option value="Borrowing" selected>Borrowing</option>
                            <option value="Returning">Returning</option>
                        </select>
                        <div class="auto-submit-toggle">
                            <input type="checkbox" id="autoSubmitCheck" checked>
                            <label for="autoSubmitCheck">Auto-Submit</label>
                        </div>
                    </div>
                    <form id="scanForm">
                        <div class="form-group" id="studentIdPrefixGroup">
                            <label for="studentIdPrefixInput">Prefix/Suffix for Student ID</label>
                            <input type="text" id="studentIdPrefixInput" class="prefix-input" placeholder="Enter prefix/suffix">
                        </div>
                        <div class="form-group" id="studentIdGroup">
                            <label for="studentIdInput">1. Scan Student ID</label>
                            <input type="text" id="studentIdInput" class="scan-input" placeholder="Scan Student ID to Borrow..." autocomplete="off">
                        </div>
                        <div id="itemIdGroup" style="display: none;">
                            <div class="form-group" id="itemIdPrefixGroup">
                                <label for="itemIdPrefixInput">Prefix/Suffix for Item</label>
                                <input type="text" id="itemIdPrefixInput" class="prefix-input" placeholder="Enter prefix/suffix">
                            </div>
                            <div class="form-group">
                               <label for="itemIdInput">2. Scan Item Barcode</label>
                               <input type="text" id="itemIdInput" class="scan-input" placeholder="Scan Item to Borrow..." autocomplete="off">
                            </div>
                        </div>
                    </form>
                    <div id="scanStatus" class="status-box">
                        Awaiting scan...
                    </div>
                </section>
                <section class="inventory-card">
                    <h2>Live Tracking Details</h2>
                    <div id="trackingDetailsContainer">
                        <p>Scan an item to see its details here.</p>
                    </div>
                </section>
            </div>
        </div>
        
        <div id="super-admin-content" class="page-content">
            <h1>Super Admin Overview</h1>
            <p class="page-subtitle">Monitoring all inventories and requests across the system.</p>
            
            <section class="inventory-card">
                <h2>Science Inventory (Admin 2)</h2>
                <table id="tableAdmin2ScienceInventory">
                    <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Qty</th><th>Location</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
            <section class="inventory-card">
                <h2>Sports Inventory (Admin 2)</h2>
                <table id="tableAdmin2SportsInventory">
                    <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Qty</th><th>Location</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
            <section class="inventory-card">
                <h2>Facility Inventory (Admin 3)</h2>
                <table id="tableAdmin3Inventory">
                    <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Qty</th><th>Location</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
            <section class="inventory-card">
                <h2>Robotics Inventory (Admin 4)</h2>
                <table id="tableAdmin4Inventory">
                    <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Qty</th><th>Location</th><th>Status</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
            
            <section class="inventory-card">
                <h2>All Monitored Requests</h2>
                <table id="tableAllMonitoredRequests">
                        <thead><tr><th>Student Name</th><th>Item Name</th><th>Category</th><th>Status</th><th>Request Date</th></tr></thead>
                        <tbody></tbody>
                </table>
            </section>
        </div>
        
        <div id="user-management-content" class="page-content">
            <h1>User Management</h1>
            <p class="page-subtitle">Create, view, and manage all user accounts in the system.</p>
            <section class="inventory-card">
                <h2>Add New User</h2>
                <form class="add-form" id="addUserForm">
                    <input type="text" name="firstName" placeholder="First Name" required />
                    <input type="text" name="lastName" placeholder="Last Name" required />
                    <input type="text" name="username" placeholder="Username" required />
                    <input type="email" name="email" placeholder="Email" required />
                    <input type="text" name="studentID" placeholder="Student/Employee ID" required />
                    <input type="password" name="password" placeholder="Password" required />
                    <select name="role" required>
                        <option value="student">Student</option>
                        <option value="admin">Admin</option>
                    </select>
                    <button type="submit">Add User</button>
                </form>
            </section>
            <section class="inventory-card">
                <h2>All System Users</h2>
                <div class="filter-row">
                    <div class="search-bar">
                        <input type="text" id="searchUsers" placeholder="Search by name, ID, or email..." />
                    </div>
                </div>
                <table id="usersTable">
                    <thead><tr><th>Full Name</th><th>Username</th><th>Student ID</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </section>
        </div>

        <div id="profile-requests-content" class="page-content">
            <h1>Profile Update Requests</h1>
            <p class="page-subtitle">Review and process student requests to update their profile information.</p>
            <section class="inventory-card">
                <h2>Pending Requests</h2>
                <table id="profileRequestsTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Current Name</th>
                            <th>Requested Name</th>
                            <th>Requested Email</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="profileRequestsTableBody"></tbody>
                </table>
            </section>
        </div>

        <div id="registration-requests-content" class="page-content">
            <h1>New User Registration Requests</h1>
            <p class="page-subtitle">Approve or reject new student accounts waiting for activation.</p>
            <section class="inventory-card">
                <h2>Pending Registrations</h2>
                <table id="registrationRequestsTable">
                    <thead>
                        <tr>
                            <th>Full Name</th>
                            <th>Username</th>
                            <th>Student ID</th>
                            <th>Email</th>
                            <th>Registration Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="registrationRequestsTableBody"></tbody>
                </table>
            </section>
        </div>

        <div id="inventory-content" class="page-content">
            <h1>Manage Own Inventories</h1>
            <p class="page-subtitle">Science Lab Equipment</p>
            <section class="inventory-card">
                <h2>Add New Science Equipment</h2>
                <form class="add-form" id="addFormScience">
                    <input type="text" name="itemId" placeholder="Item ID (e.g., SCI-001)" required />
                    <input type="text" name="name" placeholder="Equipment Name" required />
                    <input type="hidden" name="category" value="Science" />
                    <input type="number" name="quantity" placeholder="Quantity" min="0" required />
                    <input type="text" name="location" placeholder="Location" required />
                    <button type="submit">Add Item</button>
                </form>
            </section>
            <section class="inventory-card">
                <div class="filter-row">
                    <div class="search-bar">
                        <input type="text" id="searchScience" placeholder="Search science equipment..." />
                    </div>
                     <div class="filter-select">
                        <label for="inventoryStatusFilterScience">Status</label>
                        <select id="inventoryStatusFilterScience">
                            <option value="All">All Statuses</option>
                            <option value="Available">Available</option>
                            <option value="In-Use">In-Use</option>
                            <option value="Maintenance">Maintenance</option>
                        </select>
                    </div>
                </div>
                <table id="tableScience">
                    <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Total Qty</th><th>Borrowed</th><th>Available</th><th>Location</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>

            <p class="page-subtitle" style="margin-top: 2.5rem; border-top: 1px solid var(--border-light); padding-top: 2.5rem;">Sports Equipment</p>
            <section class="inventory-card">
                <h2>Add New Sports Equipment</h2>
                <form class="add-form" id="addFormSports">
                    <input type="text" name="itemId" placeholder="Item ID (e.g., SPO-001)" required />
                    <input type="text" name="name" placeholder="Equipment Name" required />
                    <input type="hidden" name="category" value="Sports" />
                    <input type="number" name="quantity" placeholder="Quantity" min="0" required />
                    <input type="text" name="location" placeholder="Location" required />
                    <button type="submit">Add Item</button>
                </form>
            </section>
            <section class="inventory-card">
                <div class="filter-row">
                    <div class="search-bar">
                        <input type="text" id="searchSports" placeholder="Search sports equipment..." />
                    </div>
                    <div class="filter-select">
                        <label for="inventoryStatusFilterSports">Status</label>
                        <select id="inventoryStatusFilterSports">
                            <option value="All">All Statuses</option>
                            <option value="Available">Available</option>
                            <option value="In-Use">In-Use</option>
                            <option value="Maintenance">Maintenance</option>
                        </select>
                    </div>
                </div>
                <table id="tableSports">
                    <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Total Qty</th><th>Borrowed</th><th>Available</th><th>Location</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
        </div>

        <div id="requests-content" class="page-content">
            <h1 id="requests-title">Manage Student Requests</h1>
            <p class="page-subtitle">Approve or reject pending equipment requests for Science & Sports.</p>
            <section class="inventory-card">
                 <div class="filter-row">
                    <div class="search-bar">
                        <input type="text" id="requestSearch" placeholder="Search by student, item name, or ID..." />
                    </div>
                    <div class="filter-select">
                        <label for="requestStatusFilter">Filter by Status</label>
                        <select id="requestStatusFilter">
                            <option value="All">All Statuses</option>
                            <option value="Pending">Pending</option>
                            <option value="Approved">Approved</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Returned">Returned</option>
                        </select>
                    </div>
                    <button id="toggleTrashViewBtn">View Trash</button>
                </div>
                <table id="requestsTable">
                    <thead>
                        <tr>
                            <th>Student Name</th><th>Item ID</th><th>Item Name</th><th>Start Date</th><th>Due Date</th><th>Quantity</th><th>Reason</th><th>Status</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTableBody"></tbody>
                </table>
            </section>
        </div>

        <div id="notifications-content" class="page-content">
            <h1>Notifications</h1>
            <p class="page-subtitle">Latest activities and alerts.</p>
            <div id="notification-list"></div>
        </div>
        
        <div id="history-content" class="page-content">
            <h1>Admin Action History</h1>
            <p class="page-subtitle">A log of all administrative actions performed in the system.</p>
             <section class="inventory-card">
                <div class="filter-row">
                    <div class="filter-select" style="min-width: 250px;">
                        <label for="historyActionFilter">Filter by Action</label>
                        <select id="historyActionFilter">
                            <option value="All">All Actions</option>
                        </select>
                    </div>
                </div>
                 <table id="historyTable">
                    <thead>
                        <tr>
                            <th>Admin</th>
                            <th>Action</th>
                            <th>Details</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </section>
        </div>

        <div id="reports-content" class="page-content">
            <h1>Generate Reports</h1>
            <p class="page-subtitle">View and print inventory, request, and user reports.</p>
            <section class="inventory-card">
              <label for="reportType">Select Report Type:</label>
              <select id="reportType" required style="padding:8px; border-radius:5px; border:1px solid var(--border-light); margin-bottom:1rem; width: 250px;">
                <option value="">Select Report Type</option>
                <option value="inventory">Inventory Report</option>
                <option value="requests">Requests Report</option>
                <option value="usage">Usage Report</option>
                <option value="registeredStudents">Registered Students Report</option>
              </select>
              <div style="margin-bottom:1rem;">
                <button id="dailyBtn" class="period-btn active">Daily</button>
                <button id="weeklyBtn" class="period-btn">Weekly</button>
                <button id="yearlyBtn" class="period-btn">Yearly</button>
              </div>
              <button id="generateReportBtn" style="background-color: var(--primary-dark); color: var(--accent-gold); padding: 10px 20px; border-radius: 5px; border:none; cursor:pointer; font-weight:600;">Generate Report</button>
            </section>
            <section class="inventory-card" id="reportResult" style="display:none; white-space: pre-wrap; font-family: monospace; font-size: 0.95rem;"></section>
            <button id="printReportBtn" style="display:none; background-color: var(--primary-dark); color: var(--accent-gold); padding: 10px 20px; border-radius: 5px; border:none; cursor:pointer; font-weight:600; margin-top: 1rem;">Print Report</button>
        </div>
    </main>
    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="editModalTitle">Edit Item</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="editForm"></form>
        </div>
    </div>

    <div id="statusEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Request Status</h2>
                <span class="close-button">&times;</span>
            </div>
            <form id="statusEditForm">
                <input type="hidden" id="statusRequestId">
                <label for="statusSelect">Status</label>
                <select id="statusSelect" required>
                    <option value="Pending">Pending</option>
                    <option value="Approved">Approved</option>
                    <option value="Rejected">Rejected</option>
                    <option value="Returned">Returned</option>
                </select>
                <button type="submit">Update Status</button>
            </form>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 1. CONFIGURATION & STATE ---
            const inventoryTypes = {
                Science: { 
                    api: '/api/inventory2', store: [], tableBody: document.querySelector('#tableScience tbody'), 
                    searchInput: document.getElementById('searchScience'), addForm: document.getElementById('addFormScience'),
                    statusFilter: document.getElementById('inventoryStatusFilterScience') 
                },
                Sports: { 
                    api: '/api/inventory3', store: [], tableBody: document.querySelector('#tableSports tbody'), 
                    searchInput: document.getElementById('searchSports'), addForm: document.getElementById('addFormSports'),
                    statusFilter: document.getElementById('inventoryStatusFilterSports')
                }
            };
            
            let allRequestsData = [], allUsersData = [], allHistoryLogs = [], notifications = [];
            let isViewingTrash = false; // State for request trash view
            let inventoryPieChartInstance = null;
            let requestStatusBarChartInstance = null;

            const body = document.body;
            const editModal = document.getElementById('editModal');
            const statusEditModal = document.getElementById('statusEditModal');
            const editForm = document.getElementById('editForm');
            const requestsTableBody = document.getElementById('requestsTableBody');
            const notificationList = document.getElementById('notification-list');
            const notificationBadge = document.getElementById('notification-badge');
            const requestSearch = document.getElementById('requestSearch');
            const requestStatusFilter = document.getElementById('requestStatusFilter');
            const toggleTrashViewBtn = document.getElementById('toggleTrashViewBtn');
            const requestsTitle = document.getElementById('requests-title');
            const logo = document.querySelector('.logo img');

            // --- LIVE SCAN ---
            const scanForm = document.getElementById('scanForm');
            const scanMode = document.getElementById('scanMode');
            const scanStatus = document.getElementById('scanStatus');
            const trackingDetailsContainer = document.getElementById('trackingDetailsContainer');
            
            const autoSubmitCheck = document.getElementById('autoSubmitCheck');
            const studentIdPrefixInput = document.getElementById('studentIdPrefixInput');
            const studentIdInput = document.getElementById('studentIdInput');
            const itemIdPrefixInput = document.getElementById('itemIdPrefixInput');
            const itemIdInput = document.getElementById('itemIdInput');
            
            const studentIdPrefixGroup = document.getElementById('studentIdPrefixGroup');
            const studentIdGroup = document.getElementById('studentIdGroup');
            const itemIdGroup = document.getElementById('itemIdGroup');
            let currentBorrowingStudentId = null;
            let scanDebounceTimer = null;
            
            // User Management Elements
            const addUserForm = document.getElementById('addUserForm');
            const usersTableBody = document.getElementById('usersTableBody');
            const searchUsersInput = document.getElementById('searchUsers');

            // History Filter
            const historyActionFilter = document.getElementById('historyActionFilter');
            
            // --- 2. INITIALIZATION ---
            function initializeApp() {
                setupEventListeners();
                showPage('dashboard');
                fetchAdminNotifications();
            }

            function setupEventListeners() {
                document.querySelector(".toggle-btn").addEventListener("click", () => body.classList.toggle("sidebar-collapsed"));
                
                const darkToggle = document.querySelector(".dark-toggle");
                darkToggle.addEventListener("click", () => {
                    body.classList.toggle("dark");
                    const isDarkMode = body.classList.contains("dark");
                    localStorage.setItem("dark-mode", isDarkMode);
                    darkToggle.querySelector('.sun-icon').style.display = isDarkMode ? 'none' : 'block';
                    darkToggle.querySelector('.moon-icon').style.display = isDarkMode ? 'block' : 'none';
                    if(document.getElementById('dashboard-content').classList.contains('active')) {
                        updateSuperAdminDashboard();
                    }
                });
                
                document.querySelectorAll("#sidebar nav a[data-page]").forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        showPage(link.dataset.page)
                    });
                });

                const mainContentArea = document.querySelector('main');
                mainContentArea.addEventListener('click', (event) => {
                    const liveScanPage = document.getElementById('live-scan-content');
                    if (liveScanPage.classList.contains('active') && !event.target.closest('.live-scan-container form, .live-scan-container select')) {
                        if (itemIdGroup.style.display !== 'none') {
                            itemIdPrefixInput.focus();
                        } 
                        else if (studentIdGroup.style.display !== 'none') {
                            studentIdPrefixInput.focus();
                        }
                    }
                });


                for (const type in inventoryTypes) {
                    inventoryTypes[type].addForm.addEventListener('submit', (e) => handleAddItem(e, type));
                    inventoryTypes[type].searchInput.addEventListener('input', () => renderTable(type));
                    inventoryTypes[type].statusFilter.addEventListener('change', () => renderTable(type));
                }

                logo.addEventListener('click', () => showPage('dashboard'));

                // Requests Tab Listeners
                requestSearch.addEventListener('input', renderRequestsTable);
                requestStatusFilter.addEventListener('change', renderRequestsTable);
                toggleTrashViewBtn.addEventListener('click', toggleRequestView);

                // History Filter Listener
                historyActionFilter.addEventListener('change', renderHistoryLogs);

                addUserForm.addEventListener('submit', handleCreateUser);
                searchUsersInput.addEventListener('input', renderUsersTable);

                editForm.addEventListener('submit', handleUpdateItem);
                editModal.querySelector('.close-button').onclick = () => editModal.style.display = 'none';
                statusEditModal.querySelector('.close-button').onclick = () => statusEditModal.style.display = 'none';
                window.addEventListener('click', (event) => { 
                    if (event.target == editModal) editModal.style.display = 'none'; 
                    if (event.target == statusEditModal) statusEditModal.style.display = 'none';
                });
                
                document.getElementById('statusEditForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const requestId = document.getElementById('statusRequestId').value;
                    const newStatus = document.getElementById('statusSelect').value;
                    const req = allRequestsData.find(r => r._id === requestId);
                    if (req) {
                        handleRequest(requestId, newStatus);
                    }
                    statusEditModal.style.display = 'none';
                });

                // --- LIVE SCAN Event Listeners ---
                scanMode.addEventListener('change', resetScannerUI);

                scanForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    processScan(document.activeElement);
                });

                const handleAutoSubmit = (event) => {
                    clearTimeout(scanDebounceTimer);
                    if (autoSubmitCheck.checked) {
                        scanDebounceTimer = setTimeout(() => {
                            processScan(event.target);
                        }, 200);
                    }
                };
                studentIdInput.addEventListener('input', handleAutoSubmit);
                itemIdInput.addEventListener('input', handleAutoSubmit);
            }
            
            // --- 3. PAGE NAVIGATION & CONTENT LOADING ---
            window.showPage = (pageId) => {
                document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
                const page = document.getElementById(`${pageId}-content`);
                if (page) {
                    page.classList.add('active');
                }
                document.querySelectorAll("#sidebar nav a[data-page]").forEach(l => l.classList.toggle('active', l.dataset.page === pageId));

                if (pageId === 'dashboard') {
                    updateSuperAdminDashboard();
                } else if (pageId === 'inventory') {
                    for (const type in inventoryTypes) fetchInventory(type);
                } else if (pageId === 'requests') {
                    // Reset to active view when navigating to the page
                    isViewingTrash = false;
                    fetchAllRequests();
                } else if (pageId === 'notifications') {
                    renderNotifications();
                } else if (pageId === 'history') {
                    fetchHistoryLogs();
                } else if (pageId === 'super-admin') {
                    loadSuperAdminData();
                } else if (pageId === 'user-management') {
                    fetchAllUsers();
                } else if (pageId === 'profile-requests') {
                    fetchProfileUpdateRequests();
                } else if (pageId === 'registration-requests') {
                    fetchPendingRegistrations();
                } else if (pageId === 'live-scan') {
                    initializeLiveScan();
                }
            };

            // --- LIVE SCAN FUNCTIONS ---
            function initializeLiveScan() {
                resetScannerUI();
            }
            
            function clearTrackingDetails() {
                trackingDetailsContainer.innerHTML = '<p>Scan an item to see its details here.</p>';
            }

            function resetScannerUI() {
                currentBorrowingStudentId = null;
                studentIdInput.value = '';
                itemIdInput.value = '';
                studentIdPrefixInput.value = '';
                itemIdPrefixInput.value = '';
                studentIdInput.readOnly = false;
                
                scanStatus.textContent = 'Awaiting scan...';
                scanStatus.className = 'status-box';
                
                const mode = scanMode.value;
                if (mode === 'Returning') {
                    studentIdPrefixGroup.style.display = 'none';
                    studentIdGroup.style.display = 'none';
                    itemIdGroup.style.display = 'block';
                    itemIdInput.placeholder = 'Scan item to RETURN...';
                    itemIdPrefixInput.focus();
                } else { // Borrowing
                    studentIdPrefixGroup.style.display = 'block';
                    studentIdGroup.style.display = 'block';
                    itemIdGroup.style.display = 'none';
                    studentIdInput.placeholder = 'Scan student ID to BORROW...';
                    studentIdPrefixInput.focus();
                }
                clearTrackingDetails();
            }

            async function fetchAndDisplayItemDetails(itemId) {
                trackingDetailsContainer.innerHTML = '<p>Loading item details...</p>';
                try {
                    const response = await fetch(`/api/item-details/${itemId}`);
                    if (!response.ok) {
                        throw new Error('Item not found in database.');
                    }
                    const data = await response.json();

                    const statusClass = (data.status || 'Available').replace(/[^a-zA-Z0-9]/g, '');
                    let trackingHTML = `
                        <h3>${data.name}</h3>
                        <p>
                            <strong>ID:</strong> ${data.itemId} | 
                            <strong>Status:</strong> <span class="status-badge status-${statusClass}">${data.status}</span>
                        </p>
                    `;

                    if (data.currentLoan) {
                        trackingHTML += `
                        <div id="trackingBorrowerInfo">
                            <p class="detail-item">Currently Borrowed By:</p>
                            <span>${data.currentLoan.studentName} (${data.currentLoan.studentID})</span><br>
                            <span><strong>Due Date:</strong> ${new Date(data.currentLoan.dueDate).toLocaleDateString()}</span>
                        </div>`;
                    }
                    
                    trackingHTML += `<h4>History</h4><div id="trackingHistoryLog">`;
                    if(data.history && data.history.length > 0) {
                        data.history.forEach(log => {
                            trackingHTML += `<div><strong>${log.action}</strong> by ${log.studentName || 'N/A'} on ${new Date(log.timestamp).toLocaleString()}</div>`;
                        });
                    } else {
                        trackingHTML += `<div>No transaction history for this item.</div>`;
                    }
                    trackingHTML += `</div>`;

                    trackingDetailsContainer.innerHTML = trackingHTML;

                } catch (error) {
                    trackingDetailsContainer.innerHTML = `<p style="color: var(--danger);">${error.message}</p>`;
                }
            }

            async function processScan(triggeredInput) {
                const mode = scanMode.value;

                if (mode === 'Borrowing') {
                    const studentIdValue = studentIdInput.value.trim();
                    if (triggeredInput === studentIdInput && studentIdValue !== '') {
                        currentBorrowingStudentId = studentIdValue;
                        studentIdInput.readOnly = true;
                        scanStatus.textContent = `Student ID ${currentBorrowingStudentId} captured. Now scan the item.`;
                        itemIdGroup.style.display = 'block';
                        itemIdPrefixInput.focus();
                        return;
                    }
                    
                    const itemIdValue = itemIdInput.value.trim();
                    if (triggeredInput === itemIdInput && itemIdValue !== '' && currentBorrowingStudentId) {
                        const finalItemId = itemIdValue;
                        const studentID = currentBorrowingStudentId;
                        
                        await fetchAndDisplayItemDetails(finalItemId);
                        
                        try {
                           const response = await fetch('/api/borrow-by-barcode', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ itemId: finalItemId, studentID })
                           });
                           const result = await response.json();
                           if (!response.ok) throw new Error(result.message || 'Failed to process borrowing.');

                           scanStatus.textContent = result.message;
                           scanStatus.className = 'status-box success';
                           showToast(result.message, 'success');
                           setTimeout(() => fetchAndDisplayItemDetails(finalItemId), 500);
                        } catch(error) {
                           scanStatus.textContent = error.message;
                           scanStatus.className = 'status-box error';
                           showToast(error.message, 'error');
                        } finally {
                           setTimeout(resetScannerUI, 1500);
                        }
                    }
                } else { // Returning mode
                    const itemIdValue = itemIdInput.value.trim();
                    if (triggeredInput === itemIdInput && itemIdValue) {
                        const finalItemId = itemIdValue;

                        await fetchAndDisplayItemDetails(finalItemId);

                        try {
                            const response = await fetch('/api/return-by-barcode', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ itemId: finalItemId })
                            });
                            const result = await response.json();
                            if (!response.ok) throw new Error(result.message || 'Failed to process return.');

                            scanStatus.textContent = result.message;
                            scanStatus.className = 'status-box success';
                            showToast(result.message, 'success');
                            setTimeout(() => fetchAndDisplayItemDetails(finalItemId), 500);
                        } catch(error) {
                            scanStatus.textContent = error.message;
                            scanStatus.className = 'status-box error';
                            showToast(error.message, 'error');
                        } finally {
                           itemIdInput.value = '';
                           itemIdPrefixInput.value = '';
                           itemIdPrefixInput.focus();
                        }
                    }
                }
            }


            // --- 4. DASHBOARD & CHARTS ---
            async function updateSuperAdminDashboard() {
                try {
                    const [
                        admin2InvRes,
                        admin3InvRes, 
                        admin4InvRes, 
                        admin2ReqRes,
                        admin3ReqRes, 
                        admin4ReqRes
                    ] = await Promise.all([
                        Promise.all([fetch('/api/inventory2'), fetch('/api/inventory3')]),
                        Promise.all([fetch('/api/inventory4'), fetch('/api/inventory5'), fetch('/api/inventory6'), fetch('/api/inventory8')]),
                        fetch('/api/inventory7'),
                        fetch('/api/admin2-requests'),
                        fetch('/api/admin3-requests'),
                        fetch('/api/admin-requests/Robotics')
                    ]);

                    const admin2InventoriesJson = await Promise.all(admin2InvRes.map(res => res.json()));
                    const admin2Inventories = [].concat(...admin2InventoriesJson);
                    const admin3InventoriesJson = await Promise.all(admin3InvRes.map(res => res.json()));
                    const admin3Inventories = [].concat(...admin3InventoriesJson);
                    const admin4Inventories = await admin4InvRes.json();
                    
                    const admin2ScienceTotal = admin2Inventories.filter(i => i.category === 'Science').reduce((sum, item) => sum + (item.originalQuantity || 0), 0);
                    const admin2SportsTotal = admin2Inventories.filter(i => i.category === 'Sports').reduce((sum, item) => sum + (item.originalQuantity || 0), 0);
                    const admin3Total = admin3Inventories.reduce((sum, item) => sum + (item.originalQuantity || 0), 0);
                    const admin4Total = admin4Inventories.reduce((sum, item) => sum + (item.originalQuantity || 0), 0);

                    document.getElementById('admin2-science-card').setAttribute('data-target', admin2ScienceTotal);
                    document.getElementById('admin2-sports-card').setAttribute('data-target', admin2SportsTotal);
                    document.getElementById('admin3-total-card').setAttribute('data-target', admin3Total);
                    document.getElementById('admin4-total-card').setAttribute('data-target', admin4Total);
                    animateCounters();
                    
                    const allMonitoredInventories = [...admin2Inventories, ...admin3Inventories, ...admin4Inventories];
                    renderInventoryPieChart(allMonitoredInventories);
                    
                    const allMonitoredRequests = [
                        ...(await admin2ReqRes.json()),
                        ...(await admin3ReqRes.json()), 
                        ...(await admin4ReqRes.json())
                    ];
                    renderRequestStatusBarChart(allMonitoredRequests);

                } catch (error) {
                    console.error("Super Admin Dashboard Error:", error);
                    showToast("Error loading monitoring data.");
                }
            }


            function animateCounters() {
                document.querySelectorAll(".counter").forEach(counter => {
                    counter.innerText = '0';
                    const update = () => {
                        const target = +counter.getAttribute("data-target") || 0;
                        const count = +counter.innerText;
                        const increment = Math.max(1, Math.ceil((target - count) / 10));
                        if (count < target) {
                            counter.innerText = `${Math.min(target, count + increment)}`;
                            setTimeout(update, 40);
                        } else { counter.innerText = target; }
                    };
                    update();
                });
            }
            
            function renderInventoryPieChart(inventories) {
                const ctx = document.getElementById('inventoryPieChart').getContext('2d');
                if (inventoryPieChartInstance) inventoryPieChartInstance.destroy();

                const categoryTotals = inventories.reduce((acc, item) => {
                    acc[item.category] = (acc[item.category] || 0) + (item.originalQuantity || 0);
                    return acc;
                }, {});

                inventoryPieChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categoryTotals),
                        datasets: [{
                            label: 'Total Items',
                            data: Object.values(categoryTotals),
                            backgroundColor: ['#3498db', '#9b59b6', '#f1c40f', '#e74c3c', '#2ecc71', '#34495e', '#1abc9c', '#e67e22'],
                            borderColor: body.classList.contains('dark') ? 'var(--card-bg-dark)' : 'var(--card-bg-light)',
                            borderWidth: 2
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: body.classList.contains('dark') ? 'var(--text-light)' : 'var(--text-dark)'
                                }
                            }
                        }
                    }
                });
            }

            function renderRequestStatusBarChart(requests) {
                const ctx = document.getElementById('requestStatusBarChart').getContext('2d');
                if (requestStatusBarChartInstance) requestStatusBarChartInstance.destroy();

                const statusCounts = requests.reduce((acc, req) => {
                    acc[req.status] = (acc[req.status] || 0) + 1;
                    return acc;
                }, {});

                const labels = ['Pending', 'Approved', 'Rejected', 'Returned'];
                const data = labels.map(label => statusCounts[label] || 0);
                const textColor = body.classList.contains('dark') ? 'var(--text-light)' : 'var(--text-dark)';

                requestStatusBarChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Number of Requests',
                            data: data,
                            backgroundColor: ['rgba(240, 173, 78, 0.8)', 'rgba(40, 167, 69, 0.8)', 'rgba(220, 53, 69, 0.8)', 'rgba(108, 117, 125, 0.8)'],
                            borderColor: ['#f0ad4e', '#28a745', '#dc3545', '#6c757d'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                ticks: { stepSize: 1, color: textColor } 
                            },
                            x: {
                                ticks: { color: textColor }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
            
            // --- 5. INVENTORY ---
            async function fetchInventory(type) {
                const config = inventoryTypes[type];
                try {
                    const response = await fetch(config.api);
                    if (!response.ok) throw new Error(`Failed to fetch ${type} inventory`);
                    config.store = await response.json();
                    renderTable(type);
                } catch (error) { showToast(error.message); renderTable(type); }
            }

            function renderTable(type) {
                const config = inventoryTypes[type];
                const searchTerm = config.searchInput.value.toLowerCase();
                const statusFilterValue = config.statusFilter.value;
                const filteredData = config.store.filter(item => {
                    const originalQty = item.originalQuantity || item.quantity || 0;
                    const borrowedQty = originalQty - (item.quantity || 0);
                    const currentStatus = borrowedQty > 0 ? 'In-Use' : (item.status || 'Available');
                    const matchesSearch = Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm));
                    const matchesStatus = statusFilterValue === 'All' || currentStatus === statusFilterValue;
                    return matchesSearch && matchesStatus;
                });

                config.tableBody.innerHTML = '';
                if (filteredData.length === 0) {
                    config.tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 20px;">No equipment found.</td></tr>`;
                    return;
                }
                
                filteredData.forEach(item => {
                    const originalQty = item.originalQuantity || item.quantity || 0;
                    const borrowedQty = originalQty - (item.quantity || 0);
                    const availableQty = item.quantity || 0;
                    const status = borrowedQty > 0 ? 'In-Use' : (item.status || 'Available');
                    const row = config.tableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.itemId}</td><td>${item.name}</td><td>${item.category}</td>
                        <td>${originalQty}</td><td>${borrowedQty}</td><td>${availableQty}</td><td>${item.location}</td>
                        <td>
                            <select class="status-select status-${status.replace(/[^a-zA-Z0-9]/g, '')}" onchange="updateStatus('${type}', this, '${item.itemId}')">
                                <option value="Available" ${status === 'Available' ? 'selected' : ''}>Available</option>
                                <option value="In-Use" ${status === 'In-Use' ? 'selected' : ''}>In-Use</option>
                                <option value="Maintenance" ${status === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                            </select>
                        </td>
                        <td class="actions-cell">
                            <button class="btn btn-edit" onclick="openEditModal('${type}', '${item.itemId}')">Edit</button>
                            <button class="btn btn-delete" onclick="confirmDelete('${type}', '${item.itemId}')">Delete</button>
                        </td>`;
                });
            }
            
            async function handleAddItem(e, type) {
                e.preventDefault();
                const config = inventoryTypes[type];
                const form = e.target;
                const newItem = {
                    itemId: form.querySelector('[name="itemId"]').value,
                    name: form.querySelector('[name="name"]').value,
                    category: form.querySelector('[name="category"]').value,
                    quantity: parseInt(form.querySelector('[name="quantity"]').value),
                    originalQuantity: parseInt(form.querySelector('[name="quantity"]').value),
                    location: form.querySelector('[name="location"]').value,
                    status: 'Available'
                };
                try {
                    const response = await fetch(config.api, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(newItem) 
                    });
                    if (!response.ok) throw new Error((await response.json()).message || 'Failed to add item');
                    showToast(`${type} item added!`);
                    form.reset();
                    fetchInventory(type);
                } catch (error) { showToast(`Error: ${error.message}`); }
            }

            async function handleUpdateItem(e) {
                e.preventDefault();
                const formType = document.getElementById('editForm').dataset.type;
                if (formType === 'inventory') {
                    const itemId = document.getElementById('editItemId').value;
                    const type = document.getElementById('editItemType').value;
                    const config = inventoryTypes[type];
                    const updatedData = {
                        name: document.getElementById('editItemName').value, 
                        category: document.getElementById('editCategory').value,
                        quantity: parseInt(document.getElementById('editQuantity').value), 
                        location: document.getElementById('editLocation').value,
                    };
                    try {
                        const response = await fetch(`${config.api}/${itemId}`, { 
                            method: 'PUT', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify(updatedData) });
                        if (!response.ok) throw new Error('Failed to update item');
                        showToast('Item updated successfully!');
                        editModal.style.display = 'none';
                        fetchInventory(type);
                    } catch (error) { showToast(`Error: ${error.message}`); }
                } else if (formType === 'request') {
                    const requestId = document.getElementById('editRequestId').value;
                    const updatedData = {
                        itemName: document.getElementById('editItemName').value,
                        quantity: parseInt(document.getElementById('editQuantity').value),
                        reason: document.getElementById('editReason').value,
                        startDate: document.getElementById('editStartDate').value,
                        dueDate: document.getElementById('editDueDate').value,
                    };
                    try {
                        const response = await fetch(`/api/edit-request/${requestId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updatedData) });
                        const result = await response.json();
                        if (!response.ok) throw new Error(result.message || 'Failed to update request');
                        showToast('Request updated successfully!');
                        editModal.style.display = 'none';
                        fetchAllRequests();
                    } catch (error) { showToast(`Error: ${error.message}`); }
                } else if(formType === 'user') {
                    handleUpdateUser(e);
                }
            }
            
            // --- 6. REQUESTS (With Trash Functionality) ---
            const toggleRequestView = () => {
                isViewingTrash = !isViewingTrash;
                if (isViewingTrash) {
                    fetchDeletedRequests();
                } else {
                    fetchAllRequests();
                }
            };
            
            async function fetchAllRequests() {
                try {
                    const response = await fetch('/api/admin2-requests');
                    if (!response.ok) throw new Error('Failed to fetch requests');
                    allRequestsData = await response.json();
                    if (document.getElementById('requests-content').classList.contains('active')) {
                        isViewingTrash = false;
                        renderRequestsTable();
                    }
                } catch (error) {
                    showToast(error.message);
                    if (document.getElementById('requests-content').classList.contains('active')) {
                        requestsTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">Failed to load requests.</td></tr>`;
                    }
                }
            };
            
            async function fetchDeletedRequests() {
                try {
                    const response = await fetch('/api/deleted-requests');
                    if (!response.ok) throw new Error('Failed to fetch deleted requests');
                    allRequestsData = await response.json();
                    if (document.getElementById('requests-content').classList.contains('active')) {
                        isViewingTrash = true;
                        renderRequestsTable();
                    }
                } catch (error) {
                    showToast(error.message);
                }
            }

            const renderRequestsTable = () => {
                // Update UI based on view
                requestsTitle.textContent = isViewingTrash ? 'Deleted Requests (Trash)' : 'Manage Student Requests';
                toggleTrashViewBtn.textContent = isViewingTrash ? 'View Active Requests' : 'View Trash';
                requestStatusFilter.style.display = isViewingTrash ? 'none' : 'block';

                const searchTerm = requestSearch.value.toLowerCase();
                const currentStatus = requestStatusFilter.value;
                let filtered = allRequestsData.filter(req => {
                    const matchesSearch = (req.studentName.toLowerCase().includes(searchTerm) || req.itemName.toLowerCase().includes(searchTerm) || req.itemId.toLowerCase().includes(searchTerm));
                    const matchesStatus = isViewingTrash || currentStatus === 'All' || req.status === currentStatus;
                    return matchesSearch && matchesStatus;
                });

                requestsTableBody.innerHTML = '';
                const sortedData = filtered.sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate));

                if (sortedData.length === 0) {
                    const message = isViewingTrash ? 'The trash is empty.' : 'No student requests found.';
                    requestsTableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;">${message}</td></tr>`;
                    return;
                }

                sortedData.forEach(req => {
                    const row = requestsTableBody.insertRow();
                    const startDate = req.startDate ? new Date(req.startDate).toLocaleDateString() : 'N/A';
                    const dueDate = req.dueDate ? new Date(req.dueDate).toLocaleDateString() : 'N/A';
                    
                    let actions;
                    if (isViewingTrash) {
                        actions = `
                            <button class="btn btn-restore" onclick="restoreRequest('${req._id}')">Restore</button>
                            <button class="btn btn-delete" onclick="deleteRequestPermanently('${req._id}')">Delete Permanently</button>`;
                    } else {
                        actions = `
                            <button class="btn btn-edit" onclick="openEditRequestModal('${req._id}')">Edit</button>
                            <button class="btn" style="background-color:var(--primary-light); color:white;" onclick="openStatusEditModal('${req._id}')">Status</button>
                            <button class="btn btn-delete" onclick="moveRequestToTrash('${req._id}')">Delete</button>`;
                    }

                    row.innerHTML = `
                        <td>${req.studentName}</td><td>${req.itemId}</td><td>${req.itemName}</td>
                        <td>${startDate}</td><td>${dueDate}</td><td>${req.quantity}</td><td>${req.reason}</td>
                        <td><span class="status-badge status-${req.status.replace(/[^a-zA-Z0-9]/g, '')}">${req.status}</span></td>
                        <td class="actions-cell">${actions}</td>`;
                });
            };
            
            window.handleRequest = async (requestId, newStatus) => {
                try {
                    const response = await fetch(`/api/update-request/${requestId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || `Failed to update request`);
                    showToast(result.message || `Request updated successfully.`);
                    fetchAllRequests(); // Refresh active list
                    fetchAdminNotifications();
                    for (const type in inventoryTypes) fetchInventory(type);
                } catch (error) { showToast(`Error: ${error.message}`); }
            };

            window.moveRequestToTrash = async (requestId) => {
                if (!confirm('Are you sure you want to move this request to the trash?')) return;
                try {
                    const res = await fetch(`/api/requests/${requestId}/delete`, { method: 'PUT' });
                    const result = await res.json();
                    if (!res.ok) throw new Error(result.message);
                    showToast(result.message);
                    fetchAllRequests(); // Refresh the active list
                } catch (error) { showToast(`Error: ${error.message}`); }
            };

            window.restoreRequest = async (requestId) => {
                if (!confirm('Are you sure you want to restore this request?')) return;
                try {
                    const res = await fetch(`/api/requests/${requestId}/restore`, { method: 'PUT' });
                    const result = await res.json();
                    if (!res.ok) throw new Error(result.message);
                    showToast(result.message);
                    fetchDeletedRequests(); // Refresh the trash list
                } catch (error) { showToast(`Error: ${error.message}`); }
            };

            window.deleteRequestPermanently = async (requestId) => {
                if (!confirm('WARNING: This will permanently delete the request and cannot be undone. Are you sure?')) return;
                try {
                    const res = await fetch(`/api/requests/${requestId}/permanent`, { method: 'DELETE' });
                    const result = await res.json();
                    if (!res.ok) throw new Error(result.message);
                    showToast(result.message);
                    fetchDeletedRequests(); // Refresh the trash list
                } catch (error) { showToast(`Error: ${error.message}`); }
            };
            
            // --- 7. SUPER ADMIN & USER MANAGEMENT FUNCTIONS ---
            async function loadSuperAdminData() {
                try {
                    const [admin2InvRes, admin3InvRes, admin4InvRes, admin2ReqRes, admin3ReqRes, admin4ReqRes] = await Promise.all([
                        Promise.all([fetch('/api/inventory2'), fetch('/api/inventory3')]),
                        Promise.all([fetch('/api/inventory4'), fetch('/api/inventory5'), fetch('/api/inventory6'), fetch('/api/inventory8')]),
                        fetch('/api/inventory7'),
                        fetch('/api/admin2-requests'),
                        fetch('/api/admin3-requests'),
                        fetch('/api/admin-requests/Robotics')
                    ]);

                    const admin2InventoriesJson = await Promise.all(admin2InvRes.map(res => res.json()));
                    const admin2Science = admin2InventoriesJson[0];
                    const admin2Sports = admin2InventoriesJson[1];

                    const admin3InventoriesJson = await Promise.all(admin3InvRes.map(res => res.json()));
                    const admin3Inventories = [].concat(...admin3InventoriesJson);
                    const admin4Inventories = await admin4InvRes.json();
                    
                    renderSuperAdminInventoryTable(admin2Science, document.getElementById('tableAdmin2ScienceInventory').querySelector('tbody'));
                    renderSuperAdminInventoryTable(admin2Sports, document.getElementById('tableAdmin2SportsInventory').querySelector('tbody'));
                    renderSuperAdminInventoryTable(admin3Inventories, document.getElementById('tableAdmin3Inventory').querySelector('tbody'));
                    renderSuperAdminInventoryTable(admin4Inventories, document.getElementById('tableAdmin4Inventory').querySelector('tbody'));

                    const allMonitoredRequests = [
                        ...(await admin2ReqRes.json()),
                        ...(await admin3ReqRes.json()), 
                        ...(await admin4ReqRes.json())
                    ];
                    renderSuperAdminRequestsTable(allMonitoredRequests, document.getElementById('tableAllMonitoredRequests').querySelector('tbody'));
                } catch (error) {
                    console.error("Super Admin Page Load Error:", error);
                    showToast("Error loading Super Admin data.");
                }
            }

            function renderSuperAdminInventoryTable(data, tableBody) {
                tableBody.innerHTML = '';
                if (!data || data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No inventory data.</td></tr>`;
                    return;
                }
                data.forEach(item => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.itemId}</td><td>${item.name}</td><td>${item.category}</td>
                        <td>${item.originalQuantity || item.quantity}</td><td>${item.location}</td><td>${item.status}</td>`;
                });
            }
            
            function renderSuperAdminRequestsTable(data, tableBody) {
                tableBody.innerHTML = '';
                 if (!data || data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No request data.</td></tr>`;
                    return;
                }
                data.sort((a,b) => new Date(b.requestDate) - new Date(a.requestDate)).forEach(req => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${req.studentName}</td><td>${req.itemName}</td><td>${req.category}</td>
                        <td><span class="status-badge status-${req.status.replace(/[^a-zA-Z0-9]/g, '')}">${req.status}</span></td>
                        <td>${new Date(req.requestDate).toLocaleDateString()}</td>`;
                });
            }

            async function fetchAllUsers() {
                try {
                    const response = await fetch('/api/all-users');
                    if (!response.ok) throw new Error('Failed to fetch users. You may not have super admin rights.');
                    allUsersData = await response.json();
                    renderUsersTable();
                } catch(error) {
                    showToast(error.message);
                }
            }
            
            function renderUsersTable() {
                const searchTerm = searchUsersInput.value.toLowerCase();
                const filtered = allUsersData.filter(user => 
                    user.firstName.toLowerCase().includes(searchTerm) ||
                    user.lastName.toLowerCase().includes(searchTerm) ||
                    user.username.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    user.studentID.toLowerCase().includes(searchTerm)
                );

                usersTableBody.innerHTML = '';
                filtered.forEach(user => {
                    const row = usersTableBody.insertRow();
                    row.innerHTML = `
                        <td>${user.firstName} ${user.lastName}</td>
                        <td>${user.username}</td>
                        <td>${user.studentID}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td><span class="status-badge status-${user.status}">${user.status}</span></td>
                        <td class="actions-cell">
                           <button class="btn btn-edit" onclick="openEditUserModal('${user._id}')">Edit</button>
                           <button class="btn btn-delete" onclick="deleteUser('${user._id}')">Delete</button>
                        </td>
                    `;
                });
            }

            async function handleCreateUser(e) {
                e.preventDefault();
                const form = e.target;
                const newUser = {
                    firstName: form.querySelector('[name="firstName"]').value,
                    lastName: form.querySelector('[name="lastName"]').value,
                    username: form.querySelector('[name="username"]').value,
                    email: form.querySelector('[name="email"]').value,
                    studentID: form.querySelector('[name="studentID"]').value,
                    password: form.querySelector('[name="password"]').value,
                    role: form.querySelector('[name="role"]').value,
                    gradeLevel: form.querySelector('[name="role"]').value === 'student' ? 'N/A' : 'N/A'
                };
                try {
                    const response = await fetch('/api/users', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(newUser) 
                    });
                    if (!response.ok) throw new Error((await response.text()) || 'Failed to create user');
                    showToast('User created successfully!');
                    form.reset();
                    fetchAllUsers();
                } catch (error) { showToast(`Error: ${error.message}`); }
            }
            
            window.openEditUserModal = (userId) => {
                 const user = allUsersData.find(u => u._id === userId);
                 if (user) {
                    document.getElementById('editModalTitle').innerText = 'Edit User';
                    editForm.innerHTML = `
                        <input type="hidden" id="editUserId" value="${user._id}">
                        <label for="editUserRole">Role</label>
                        <select id="editUserRole">
                            <option value="student" ${user.role === 'student' ? 'selected' : ''}>Student</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                        <label for="editUserPassword">New Password (optional)</label>
                        <input type="password" id="editUserPassword" placeholder="Leave blank to keep current password">
                        <button type="submit">Save Changes</button>`;
                    editForm.dataset.type = 'user';
                    editForm.onsubmit = handleUpdateUser;
                    editModal.style.display = 'flex';
                }
            };
            
            async function handleUpdateUser(e) {
                e.preventDefault();
                const userId = document.getElementById('editUserId').value;
                const newRole = document.getElementById('editUserRole').value;
                const newPassword = document.getElementById('editUserPassword').value;
                
                try {
                    const roleRes = await fetch(`/api/users/${userId}/role`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ role: newRole })
                    });
                    if (!roleRes.ok) throw new Error('Failed to update role');

                    if (newPassword) {
                        const passRes = await fetch(`/api/users/${userId}/reset-password`, {
                           method: 'PUT',
                           headers: { 'Content-Type': 'application/json' },
                           body: JSON.stringify({ newPassword: newPassword })
                        });
                        if (!passRes.ok) throw new Error('Failed to reset password');
                    }
                    
                    showToast('User updated successfully!');
                    editModal.style.display = 'none';
                    fetchAllUsers();
                } catch(error) {
                    showToast(`Error: ${error.message}`);
                }
            }

            window.deleteUser = async (userId) => {
                if (!confirm('Are you sure you want to delete this user? This is irreversible.')) return;
                try {
                    const response = await fetch(`/api/users/${userId}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error(await response.text());
                    showToast('User deleted successfully.');
                    fetchAllUsers();
                } catch(error) {
                    showToast(`Error: ${error.message}`);
                }
            };

            // --- PROFILE REQUESTS FUNCTIONS ---
            async function fetchProfileUpdateRequests() {
                try {
                    const response = await fetch('/api/profile-update-requests');
                    if (!response.ok) throw new Error('Failed to fetch profile update requests.');
                    const requests = await response.json();
                    renderProfileUpdateRequests(requests);
                } catch (error) {
                    showToast(error.message);
                    document.getElementById('profileRequestsTableBody').innerHTML = `<tr><td colspan="6" style="text-align:center;">${error.message}</td></tr>`;
                }
            }

            function renderProfileUpdateRequests(requests) {
                const tableBody = document.getElementById('profileRequestsTableBody');
                tableBody.innerHTML = '';
                if (requests.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No pending profile update requests.</td></tr>`;
                    return;
                }
                requests.forEach(req => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${req.username}</td>
                        <td>${req.currentFullName}</td>
                        <td>${req.newFirstName} ${req.newLastName}</td>
                        <td>${req.newEmail}</td>
                        <td>${new Date(req.requestedAt).toLocaleDateString()}</td>
                        <td class="actions-cell">
                           <button class="btn btn-edit" onclick="handleProfileRequest('${req._id}', 'approve')">Approve</button>
                           <button class="btn btn-delete" onclick="handleProfileRequest('${req._id}', 'reject')">Reject</button>
                        </td>
                    `;
                });
            }

            window.handleProfileRequest = async (requestId, action) => {
                if (!confirm(`Are you sure you want to ${action} this request?`)) return;

                try {
                    const response = await fetch(`/api/profile-update-requests/${requestId}/${action}`, {
                        method: 'PUT'
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || `Failed to ${action} request.`);
                    showToast(result.message);
                    fetchProfileUpdateRequests();
                } catch (error) {
                    showToast(`Error: ${error.message}`);
                }
            };

            // --- REGISTRATION REQUESTS FUNCTIONS ---
            async function fetchPendingRegistrations() {
                try {
                    const response = await fetch('/api/pending-registrations');
                    if (!response.ok) throw new Error('Failed to fetch pending registrations.');
                    const users = await response.json();
                    renderPendingRegistrations(users);
                } catch (error) {
                    showToast(error.message);
                    document.getElementById('registrationRequestsTableBody').innerHTML = `<tr><td colspan="6" style="text-align:center;">${error.message}</td></tr>`;
                }
            }

            function renderPendingRegistrations(users) {
                const tableBody = document.getElementById('registrationRequestsTableBody');
                tableBody.innerHTML = '';
                if (users.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No pending registrations.</td></tr>`;
                    return;
                }
                users.forEach(user => {
                    const row = tableBody.insertRow();
                    const registrationDate = new Date(parseInt(user._id.substring(0, 8), 16) * 1000).toLocaleDateString();
                    row.innerHTML = `
                        <td>${user.firstName} ${user.lastName}</td>
                        <td>${user.username}</td>
                        <td>${user.studentID}</td>
                        <td>${user.email}</td>
                        <td>${registrationDate}</td>
                        <td class="actions-cell">
                           <button class="btn btn-edit" onclick="handleRegistration('${user._id}', 'approve')">Approve</button>
                           <button class="btn btn-delete" onclick="handleRegistration('${user._id}', 'reject')">Reject</button>
                        </td>
                    `;
                });
            }

            window.handleRegistration = async (userId, action) => {
                const confirmationText = action === 'reject' 
                    ? 'Are you sure you want to reject and delete this registration? This is irreversible.'
                    : `Are you sure you want to ${action} this registration?`;
                if (!confirm(confirmationText)) return;

                const url = `/api/registrations/${userId}/${action}`;
                const method = action === 'approve' ? 'PUT' : 'DELETE';

                try {
                    const response = await fetch(url, { method });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message || `Failed to ${action} registration.`);
                    showToast(result.message);
                    fetchPendingRegistrations();
                } catch (error) {
                    showToast(`Error: ${error.message}`);
                }
            };

            // --- 8. NOTIFICATIONS, HISTORY & UTILITIES ---
            const updateNotificationBadge = () => {
                const unreadCount = notifications.filter(n => !n.isRead).length;
                notificationBadge.textContent = unreadCount;
                notificationBadge.style.display = unreadCount > 0 ? 'inline-block' : 'none';
            };
            
            const renderNotifications = () => {
                notificationList.innerHTML = '';
                if (notifications.length === 0) {
                    notificationList.innerHTML = '<p>No new notifications.</p>';
                } else {
                    notifications.forEach(n => {
                        const item = document.createElement('div');
                        item.className = 'notification-item';
                        item.innerHTML = `<div class="notification-title">${n.title}</div><div class="notification-message">${n.message}</div><div class="notification-time">${new Date(n.createdAt).toLocaleString()}</div>`;
                        notificationList.appendChild(item);
                    });
                }
                fetch('/api/notifications/mark-read', { method: 'POST' });
                notifications.forEach(n => n.isRead = true);
                updateNotificationBadge();
            };

            async function fetchAdminNotifications() {
                try {
                    const response = await fetch('/api/admin/notifications');
                    if (!response.ok) throw new Error('Could not fetch notifications.');
                    notifications = await response.json();
                    if (document.getElementById('notifications-content').classList.contains('active')) {
                        renderNotifications();
                    }
                    updateNotificationBadge();
                } catch (error) {
                    console.error(error);
                    showToast(error.message);
                }
            }
            
            async function fetchHistoryLogs() {
                try {
                    const response = await fetch('/api/admin/history');
                    if (!response.ok) throw new Error('Failed to fetch history logs.');
                    allHistoryLogs = await response.json(); // Store full log
                    
                    // Populate filter dropdown
                    const actions = [...new Set(allHistoryLogs.map(log => log.action))];
                    historyActionFilter.innerHTML = '<option value="All">All Actions</option>';
                    actions.sort().forEach(action => {
                        const option = document.createElement('option');
                        option.value = action;
                        option.textContent = action;
                        historyActionFilter.appendChild(option);
                    });

                    renderHistoryLogs(); // Initial render
                } catch (error) {
                    showToast(error.message);
                }
            }

            function renderHistoryLogs() {
                const tableBody = document.getElementById('historyTableBody');
                const selectedAction = historyActionFilter.value;

                const logs = selectedAction === 'All' 
                    ? allHistoryLogs 
                    : allHistoryLogs.filter(log => log.action === selectedAction);

                tableBody.innerHTML = '';
                if (logs.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No history found for this filter.</td></tr>';
                    return;
                }
                logs.forEach(log => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${log.adminUsername}</td>
                        <td>${log.action}</td>
                        <td>${log.details}</td>
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                    `;
                });
            }

            window.openEditModal = (type, itemId) => {
                const item = inventoryTypes[type].store.find(i => i.itemId === itemId);
                if (item) {
                    document.getElementById('editModalTitle').innerText = `Edit ${type} Item`;
                    editForm.innerHTML = `
                        <input type="hidden" id="editItemId" value="${item.itemId}">
                        <input type="hidden" id="editItemType" value="${type}">
                        <label for="editItemName">Equipment Name</label><input type="text" id="editItemName" value="${item.name}" required />
                        <label for="editCategory">Category</label><input type="text" id="editCategory" value="${item.category}" readonly />
                        <label for="editQuantity">Total Quantity</label><input type="number" id="editQuantity" value="${item.originalQuantity || item.quantity}" min="0" required />
                        <label for="editLocation">Location</label><input type="text" id="editLocation" value="${item.location}" required />
                        <button type="submit">Save Changes</button>`;
                    editForm.dataset.type = 'inventory';
                    editForm.onsubmit = handleUpdateItem;
                    editModal.style.display = 'flex';
                }
            };
            
            window.openEditRequestModal = (requestId) => {
                const request = allRequestsData.find(r => r._id === requestId);
                if (request) {
                    document.getElementById('editModalTitle').innerText = 'Edit Request';
                    editForm.innerHTML = `
                        <input type="hidden" id="editRequestId" value="${request._id}">
                        <label for="editItemName">Item Name</label><input type="text" id="editItemName" value="${request.itemName}" required />
                        <label for="editQuantity">Quantity</label><input type="number" id="editQuantity" value="${request.quantity}" min="1" required />
                        <label for="editReason">Reason</label><textarea id="editReason" required>${request.reason}</textarea>
                        <label for="editStartDate">Start Date</label><input type="date" id="editStartDate" value="${request.startDate ? new Date(request.startDate).toISOString().split('T')[0] : ''}" required />
                        <label for="editDueDate">Due Date</label><input type="date" id="editDueDate" value="${request.dueDate ? new Date(request.dueDate).toISOString().split('T')[0] : ''}" required />
                        <button type="submit">Save Changes</button>`;
                    editForm.dataset.type = 'request';
                    editForm.onsubmit = handleUpdateItem;
                    editModal.style.display = 'flex';
                }
            };

            window.openStatusEditModal = (requestId) => {
                const request = allRequestsData.find(r => r._id === requestId);
                if (request) {
                    document.getElementById('statusRequestId').value = request._id;
                    document.getElementById('statusSelect').value = request.status;
                    statusEditModal.style.display = 'flex';
                }
            };

            window.confirmDelete = async (type, itemId) => {
                if (!confirm(`Are you sure you want to delete item ${itemId}?`)) return;
                try {
                    const response = await fetch(`${inventoryTypes[type].api}/${itemId}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Failed to delete item');
                    showToast('Item deleted successfully.');
                    fetchInventory(type);
                } catch (error) { showToast(`Error: ${error.message}`); }
            };

            window.updateStatus = async (type, selectElement, itemId) => {
                const newStatus = selectElement.value;
                try {
                    const response = await fetch(`${inventoryTypes[type].api}/${itemId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) });
                    if (!response.ok) throw new Error('Failed to update status');
                    showToast(`Status for ${itemId} updated.`);
                    selectElement.className = `status-select status-${newStatus.replace(/[^a-zA-Z0-9]/g, '')}`;
                } catch (error) { showToast(`Error: ${error.message}`); fetchInventory(type); }
            };
            
            window.showToast = (message) => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 3000);
            };

            // --- 9. Reports Feature ---
            const reportTypeSelect = document.getElementById('reportType');
            const generateReportBtn = document.getElementById('generateReportBtn');
            const reportResult = document.getElementById('reportResult');
            const printReportBtn = document.getElementById('printReportBtn');
            let selectedPeriod = 'daily';
            const periodBtns = document.querySelectorAll('.period-btn');
            periodBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    periodBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedPeriod = btn.id.replace('Btn', '');
                });
            });

            generateReportBtn.addEventListener('click', async () => {
                const selectedReportType = reportTypeSelect.value;
                reportResult.style.display = 'none';
                printReportBtn.style.display = 'none';
                if (!selectedReportType) {
                    showToast('Please select a report type.');
                    return;
                }
                
                // Log report generation attempt
                try {
                    await fetch('/api/reports', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reportType: selectedReportType })
                    });
                } catch (e) { console.error("Failed to log report generation", e); }


                showToast('Generating report...');

                try {
                    const now = new Date();
                    let startDate;
                    switch(selectedPeriod) {
                        case 'daily': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()); break;
                        case 'weekly': const day = now.getDay(); startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day); break;
                        case 'yearly': startDate = new Date(now.getFullYear(), 0, 1); break;
                        default: startDate = new Date(0);
                    }
                    
                    let reportText = `<b>Report Type:</b> ${reportTypeSelect.options[reportTypeSelect.selectedIndex].text} (${selectedPeriod})<br>`;
                    reportText += `<b>Date Range:</b> ${startDate.toLocaleDateString()} - ${now.toLocaleDateString()}<br><br>`;
                    
                    if (selectedReportType === 'inventory' || selectedReportType === 'requests' || selectedReportType === 'usage') {
                        const inventoryDataArrays = await Promise.all(
                            Object.values(inventoryTypes).map(type => fetch(type.api).then(res => res.json()))
                        );
                        const allInventory = [].concat(...inventoryDataArrays);
                        const requestsResponse = await fetch('/api/admin2-requests');
                        if (!requestsResponse.ok) throw new Error('Failed to fetch requests');
                        const allRequests = await requestsResponse.json();
                        const filteredRequests = allRequests.filter(r => new Date(r.requestDate) >= startDate);
                        
                        if (selectedReportType === 'inventory') {
                            const totalItems = allInventory.reduce((sum, i) => sum + (i.originalQuantity || i.quantity || 0), 0);
                            const availableItems = allInventory.reduce((sum, i) => sum + (i.quantity || 0), 0);
                            const inUseItems = totalItems - availableItems;
                            const maintenanceItems = allInventory.filter(i => i.status === 'Maintenance').length;
                            reportText += `<b>Summary:</b><br>`;
                            reportText += `Total Items: ${totalItems}<br>`;
                            reportText += `Available Items: ${availableItems}<br>`;
                            reportText += `Items In Use: ${inUseItems}<br>`;
                            reportText += `Items Under Maintenance: ${maintenanceItems}<br><br>`;
                            reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
                            reportText += `<thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Total Qty</th><th>Borrowed</th><th>Available</th><th>Location</th><th>Status</th></tr></thead><tbody>`;
                            allInventory.forEach(item => {
                                const originalQty = item.originalQuantity || item.quantity || 0;
                                const availableQty = item.quantity || 0;
                                const borrowedQty = originalQty - availableQty;
                                reportText += `<tr><td>${item.itemId}</td><td>${item.name}</td><td>${item.category}</td><td>${originalQty}</td><td>${borrowedQty}</td><td>${availableQty}</td><td>${item.location}</td><td>${item.status}</td></tr>`;
                            });
                            reportText += `</tbody></table>`;
                        } else if (selectedReportType === 'requests') {
                             reportText += `<b>Summary:</b><br>`;
                            reportText += `Pending: ${filteredRequests.filter(r => r.status === 'Pending').length}<br>`;
                            reportText += `Approved: ${filteredRequests.filter(r => r.status === 'Approved').length}<br>`;
                            reportText += `Rejected: ${filteredRequests.filter(r => r.status === 'Rejected').length}<br>`;
                            reportText += `Returned: ${filteredRequests.filter(r => r.status === 'Returned').length}<br><br>`;
                            reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
                            reportText += `<thead><tr><th>Requester</th><th>Item</th><th>Qty</th><th>Status</th><th>Date</th></tr></thead><tbody>`;
                            filteredRequests.forEach(req => {
                                reportText += `<tr><td>${req.studentName}</td><td>${req.itemName}</td><td>${req.quantity}</td><td>${req.status}</td><td>${new Date(req.requestDate).toLocaleDateString()}</td></tr>`;
                            });
                            reportText += `</tbody></table>`;
                        } else if (selectedReportType === 'usage') {
                            const usageMap = {};
                            filteredRequests.filter(r => r.status === 'Approved').forEach(req => {
                                usageMap[req.itemName] = (usageMap[req.itemName] || 0) + 1;
                            });
                            reportText += `<b>Most Used Items:</b><br>`;
                            reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
                            reportText += `<thead><tr><th>Item Name</th><th>Times Borrowed</th></tr></thead><tbody>`;
                            Object.entries(usageMap).sort((a,b) => b[1] - a[1]).forEach(([name, count]) => {
                                reportText += `<tr><td>${name}</td><td>${count}</td></tr>`;
                            });
                            reportText += `</tbody></table>`;
                        }
                    } else if (selectedReportType === 'registeredStudents') {
                        await fetchAllUsers(); // Ensure allUsersData is up-to-date
                        const filteredUsers = allUsersData.filter(user => {
                            if (user.role !== 'student') return false;
                            const registrationDate = new Date(parseInt(user._id.substring(0, 8), 16) * 1000);
                            return registrationDate >= startDate;
                        });

                        reportText += `<b>Total New Students: ${filteredUsers.length}</b><br><br>`;
                        reportText += `<table border="1" cellpadding="5" cellspacing="0" style="border-collapse: collapse; width: 100%;">`;
                        reportText += `<thead><tr><th>Full Name</th><th>Student ID</th><th>Email</th><th>Registration Date</th></tr></thead><tbody>`;
                        filteredUsers.forEach(user => {
                            const regDate = new Date(parseInt(user._id.substring(0, 8), 16) * 1000).toLocaleDateString();
                            reportText += `<tr><td>${user.firstName} ${user.lastName}</td><td>${user.studentID}</td><td>${user.email}</td><td>${regDate}</td></tr>`;
                        });
                        reportText += `</tbody></table>`;
                    }
                    
                    reportResult.innerHTML = reportText;
                    reportResult.style.display = 'block';
                    printReportBtn.style.display = 'inline-block';
                    showToast('Report generated.');
                } catch (error) { showToast(`Error generating report: ${error.message}`); }
            });

            printReportBtn.addEventListener('click', () => {
                const printWindow = window.open('', '', 'width=800,height=600');
                printWindow.document.write(`
                    <html><head><title>LabLinX Report</title>
                    <style>
                        body { font-family: sans-serif; padding: 20px; }
                        table { border-collapse: collapse; width: 100%; font-size: 0.9rem; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        h1, b { color: #00503B; }
                    </style></head><body>
                        <h1>LabLinX Report</h1>
                        ${reportResult.innerHTML}
                    </body></html>`);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();
            });

            // --- GO! ---
            initializeApp();
        });
    </script>
</body>
</html>
